import{d as P,r as _,c as w,y as Q,o as W,D as M,a as x,k as i,e as n,u as X,f as Z,E as c,g as p,i as V,j as S,t as B,l as m,q as ee,F as N,A as te,s as q,b as ie,G as oe,H as ae,I as le,_ as ne}from"./index-2179ff4f.js";import{a as ue}from"./sells-ee34ea61.js";const re={class:"edit-income-record"},se={class:"card-header"},de=P({__name:"EditIncomeRecord",setup(ge){const F={1:"CNY",2:"USD",3:"HKD",4:"THB",5:"EUR",6:"USDT",7:"USDC"},C=X(),$=Z(),I=_(),T=_(!1),b=w(()=>Number(C.params.userId)),y=w(()=>!!C.params.id),t=Q({id:0,incomeTime:null,desc:"",currencyId:null,exchangeRate:null,amount:null,distributionType:0,distributionId:void 0,fishingRatio:0,fruitRatio:0,vegetableRatio:0,huntingRatio:0,ecologyRatio:0,pieRatio:0,itype:"",userId:b.value}),d=_(new Set),U=_({}),g=_(""),l=s=>{d.value.add(s)},H=async()=>{var s;try{const e=await ue(b.value);if(e.success&&((s=e.data)!=null&&s.distribution)){const{distribution:r}=e.data;t.fishingRatio=r.fishing,t.fruitRatio=r.fruitTree,t.vegetableRatio=r.vegetable,t.huntingRatio=r.hunting,t.ecologyRatio=r.ecology,t.pieRatio=r.pie,t.distributionId=r.id,l("fishingRatio"),l("fruitRatio"),l("vegetableRatio"),l("huntingRatio"),l("ecologyRatio"),l("pieRatio"),l("distributionId")}else throw new Error("没有找到分配比例配置")}catch(e){console.error("获取分配比例失败:",e),c.error("获取分配比例失败")}},O=w(()=>t.fishingRatio+t.fruitRatio+t.vegetableRatio+t.huntingRatio+t.ecologyRatio+t.pieRatio),j={incomeTime:[{required:!0,message:"请选择收入时间",trigger:"change"}],currencyId:[{required:!0,message:"请选择币种",trigger:"change"}],amount:[{required:!0,message:"请输入收入金额",trigger:"blur"},{validator:(s,e,r)=>{e==null?r(new Error("请输入收入金额")):e<0?r(new Error("金额必须大于等于0")):r()},trigger:"blur"}],exchangeRate:[{required:!0,message:"请输入汇率",trigger:"blur"},{validator:(s,e,r)=>{e==null?r(new Error("请输入汇率")):e<=0?r(new Error("汇率必须大于0")):r()},trigger:"blur"}],distributionType:[{required:!0,message:"请选择分配类型",trigger:"change"}]},z=s=>{l("distributionType"),s===1?(g.value="",H()):(t.fishingRatio=0,t.fruitRatio=0,t.vegetableRatio=0,t.huntingRatio=0,t.ecologyRatio=0,t.pieRatio=0,g.value="",l("fishingRatio"),l("fruitRatio"),l("vegetableRatio"),l("huntingRatio"),l("ecologyRatio"),l("pieRatio"))},A=s=>{switch(console.log("选择定向分配目标:",s),t.fishingRatio=0,t.fruitRatio=0,t.vegetableRatio=0,t.huntingRatio=0,t.ecologyRatio=0,t.pieRatio=0,s){case"fruit":t.fruitRatio=100;break;case"fishing":t.fishingRatio=100;break;case"vegetable":t.vegetableRatio=100;break;case"hunting":t.huntingRatio=100;break;case"ecology":t.ecologyRatio=100;break;case"pie":t.pieRatio=100;break}l("fishingRatio"),l("fruitRatio"),l("vegetableRatio"),l("huntingRatio"),l("ecologyRatio"),l("pieRatio")},Y=()=>{if(y.value){const s=sessionStorage.getItem("editIncomeRecord");if(s)try{const e=JSON.parse(s);Object.assign(t,{id:e.id,incomeTime:new Date(e.incomeTime),desc:e.desc||"",currencyId:e.currencyId,exchangeRate:e.exchangeRate,amount:e.amount,distributionType:e.distributionType,distributionId:e.distributionId,fishingRatio:e.fishingRatio,fruitRatio:e.fruitRatio,vegetableRatio:e.vegetableRatio,huntingRatio:e.huntingRatio,ecologyRatio:e.ecologyRatio,pieRatio:e.pieRatio,itype:e.itype||"",userId:e.userId||b.value}),U.value={...t},t.distributionType===2&&M(()=>{if(Math.abs((e.fruitRatio||0)-100)<.01)g.value="fruit";else if(Math.abs((e.fishingRatio||0)-100)<.01)g.value="fishing";else if(Math.abs((e.vegetableRatio||0)-100)<.01)g.value="vegetable";else if(Math.abs((e.huntingRatio||0)-100)<.01)g.value="hunting";else if(Math.abs((e.ecologyRatio||0)-100)<.01)g.value="ecology";else if(Math.abs((e.pieRatio||0)-100)<.01)g.value="pie";else{const u=[{key:"fruit",value:e.fruitRatio||0},{key:"fishing",value:e.fishingRatio||0},{key:"vegetable",value:e.vegetableRatio||0},{key:"hunting",value:e.huntingRatio||0},{key:"ecology",value:e.ecologyRatio||0},{key:"pie",value:e.pieRatio||0}].reduce((o,R)=>R.value>o.value?R:o);u.value>0&&(g.value=u.key)}}),sessionStorage.removeItem("editIncomeRecord")}catch(e){console.error("解析编辑数据失败:",e),c.error("获取编辑数据失败"),h()}else c.error("未找到编辑数据"),h()}else U.value={...t}},D=async()=>{var s,e,r;if(I.value)try{if(await I.value.validate(),(t.distributionType===1||t.distributionType===2)&&Math.abs(O.value-100)>.01){c.error("策略分布比例总和必须为100%");return}if(y.value&&d.value.size===0&&await oe.confirm("您没有修改任何字段，确定要提交吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})!=="confirm")return;T.value=!0;const u={incomeTime:((s=t.incomeTime)==null?void 0:s.toISOString())||"",desc:t.desc,currencyId:t.currencyId||0,exchangeRate:t.exchangeRate||0,amount:t.amount||0,distributionType:t.distributionType,distributionId:t.distributionId,fishingRatio:t.fishingRatio,fruitRatio:t.fruitRatio,vegetableRatio:t.vegetableRatio,huntingRatio:t.huntingRatio,ecologyRatio:t.ecologyRatio,pieRatio:t.pieRatio,itype:t.itype,userId:t.userId};if(y.value){const o={id:t.id};d.value.has("incomeTime")&&(o.incomeTime=u.incomeTime),d.value.has("desc")&&(o.desc=u.desc),d.value.has("currencyId")&&(o.currencyId=u.currencyId),d.value.has("exchangeRate")&&(o.exchangeRate=u.exchangeRate),d.value.has("amount")&&(o.amount=u.amount),d.value.has("distributionType")?(o.distributionType=u.distributionType,o.fishingRatio=u.fishingRatio,o.fruitRatio=u.fruitRatio,o.vegetableRatio=u.vegetableRatio,o.huntingRatio=u.huntingRatio,o.ecologyRatio=u.ecologyRatio,o.pieRatio=u.pieRatio):(d.value.has("fishingRatio")&&(o.fishingRatio=u.fishingRatio),d.value.has("fruitRatio")&&(o.fruitRatio=u.fruitRatio),d.value.has("vegetableRatio")&&(o.vegetableRatio=u.vegetableRatio),d.value.has("huntingRatio")&&(o.huntingRatio=u.huntingRatio),d.value.has("ecologyRatio")&&(o.ecologyRatio=u.ecologyRatio),d.value.has("pieRatio")&&(o.pieRatio=u.pieRatio)),d.value.has("distributionId")&&(o.distributionId=u.distributionId),d.value.has("itype")&&(o.itype=u.itype),await ae(b.value,o),c.success("收入记录更新成功")}else await le(b.value,u),c.success("收入记录创建成功");h()}catch(u){console.error("提交失败:",u),c.error(((r=(e=u.response)==null?void 0:e.data)==null?void 0:r.message)||"操作失败")}finally{T.value=!1}},h=()=>{$.push({name:"UserIncomeHistory",params:{userId:b.value.toString()}})};return W(async()=>{await M(),Y()}),(s,e)=>{const r=p("el-button"),u=p("el-date-picker"),o=p("el-form-item"),R=p("el-option"),k=p("el-select"),f=p("el-input-number"),v=p("el-radio"),G=p("el-radio-group"),J=p("el-input"),K=p("el-form"),L=p("el-card");return V(),x("div",re,[i(L,null,{header:n(()=>[S("div",se,[S("h3",null,B(y.value?"编辑收入记录":"新增收入记录"),1),i(r,{onClick:h},{default:n(()=>e[20]||(e[20]=[m("返回")])),_:1,__:[20]})])]),default:n(()=>[i(K,{ref_key:"formRef",ref:I,model:t,rules:j,"label-width":"120px",onSubmit:ee(D,["prevent"])},{default:n(()=>[i(o,{label:"收入时间",prop:"incomeTime"},{default:n(()=>[i(u,{modelValue:t.incomeTime,"onUpdate:modelValue":e[0]||(e[0]=a=>t.incomeTime=a),type:"datetime",placeholder:"选择收入时间",style:{width:"100%"},onChange:e[1]||(e[1]=a=>l("incomeTime"))},null,8,["modelValue"])]),_:1}),i(o,{label:"币种",prop:"currencyId"},{default:n(()=>[i(k,{modelValue:t.currencyId,"onUpdate:modelValue":e[2]||(e[2]=a=>t.currencyId=a),placeholder:"选择币种",style:{width:"100%"},clearable:"",onChange:e[3]||(e[3]=a=>l("currencyId"))},{default:n(()=>[(V(),x(N,null,te(F,(a,E)=>i(R,{key:E,label:a,value:Number(E)},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),i(o,{label:"收入金额",prop:"amount"},{default:n(()=>[i(f,{modelValue:t.amount,"onUpdate:modelValue":e[4]||(e[4]=a=>t.amount=a),precision:2,min:0,step:.01,style:{width:"100%"},onChange:e[5]||(e[5]=a=>l("amount"))},null,8,["modelValue"])]),_:1}),i(o,{label:"汇率",prop:"exchangeRate"},{default:n(()=>[i(f,{modelValue:t.exchangeRate,"onUpdate:modelValue":e[6]||(e[6]=a=>t.exchangeRate=a),precision:4,min:0,step:1e-4,style:{width:"100%"},onChange:e[7]||(e[7]=a=>l("exchangeRate"))},null,8,["modelValue"])]),_:1}),i(o,{label:"分配类型",prop:"distributionType"},{default:n(()=>[i(k,{modelValue:t.distributionType,"onUpdate:modelValue":e[8]||(e[8]=a=>t.distributionType=a),placeholder:"选择分配类型",onChange:z},{default:n(()=>[i(R,{label:"请选择",value:0}),i(R,{label:"按比例分配",value:1}),i(R,{label:"定向分配",value:2})]),_:1},8,["modelValue"])]),_:1}),t.distributionType===1?(V(),x(N,{key:0},[i(o,{label:"种果树比例"},{default:n(()=>[i(f,{modelValue:t.fruitRatio,"onUpdate:modelValue":e[9]||(e[9]=a=>t.fruitRatio=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),i(o,{label:"钓鱼比例"},{default:n(()=>[i(f,{modelValue:t.fishingRatio,"onUpdate:modelValue":e[10]||(e[10]=a=>t.fishingRatio=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),i(o,{label:"种菜比例"},{default:n(()=>[i(f,{modelValue:t.vegetableRatio,"onUpdate:modelValue":e[11]||(e[11]=a=>t.vegetableRatio=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),i(o,{label:"狩猎比例"},{default:n(()=>[i(f,{modelValue:t.huntingRatio,"onUpdate:modelValue":e[12]||(e[12]=a=>t.huntingRatio=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),i(o,{label:"生态位比例"},{default:n(()=>[i(f,{modelValue:t.ecologyRatio,"onUpdate:modelValue":e[13]||(e[13]=a=>t.ecologyRatio=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),i(o,{label:"捡馅饼比例"},{default:n(()=>[i(f,{modelValue:t.pieRatio,"onUpdate:modelValue":e[14]||(e[14]=a=>t.pieRatio=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1})],64)):q("",!0),t.distributionType===2?(V(),ie(o,{key:1,label:"分配目标",prop:"directDistributionTarget"},{default:n(()=>[i(G,{modelValue:g.value,"onUpdate:modelValue":e[15]||(e[15]=a=>g.value=a),onChange:A},{default:n(()=>[i(v,{label:"fruit"},{default:n(()=>e[21]||(e[21]=[m("种果树")])),_:1,__:[21]}),i(v,{label:"fishing"},{default:n(()=>e[22]||(e[22]=[m("钓鱼")])),_:1,__:[22]}),i(v,{label:"vegetable"},{default:n(()=>e[23]||(e[23]=[m("种菜")])),_:1,__:[23]}),i(v,{label:"hunting"},{default:n(()=>e[24]||(e[24]=[m("狩猎")])),_:1,__:[24]}),i(v,{label:"ecology"},{default:n(()=>e[25]||(e[25]=[m("生态位")])),_:1,__:[25]}),i(v,{label:"pie"},{default:n(()=>e[26]||(e[26]=[m("捡馅饼")])),_:1,__:[26]})]),_:1},8,["modelValue"])]),_:1})):q("",!0),i(o,{label:"类型",prop:"itype"},{default:n(()=>[i(k,{modelValue:t.itype,"onUpdate:modelValue":e[16]||(e[16]=a=>t.itype=a),placeholder:"请选择收入类型",style:{width:"100%"},clearable:"",onChange:e[17]||(e[17]=a=>l("itype"))},{default:n(()=>[i(R,{label:"劳动收入",value:"劳动收入"}),i(R,{label:"投资收入",value:"投资收入"}),i(R,{label:"借贷收入",value:"借贷收入"}),i(R,{label:"其他收入",value:"其他收入"})]),_:1},8,["modelValue"])]),_:1}),i(o,{label:"描述",prop:"desc"},{default:n(()=>[i(J,{modelValue:t.desc,"onUpdate:modelValue":e[18]||(e[18]=a=>t.desc=a),type:"textarea",rows:3,placeholder:"请输入描述",onChange:e[19]||(e[19]=a=>l("desc"))},null,8,["modelValue"])]),_:1}),i(o,null,{default:n(()=>[i(r,{type:"primary",onClick:D,loading:T.value},{default:n(()=>[m(B(y.value?"更新":"创建"),1)]),_:1},8,["loading"]),i(r,{onClick:h},{default:n(()=>e[27]||(e[27]=[m("取消")])),_:1,__:[27]})]),_:1})]),_:1},8,["model"])]),_:1})])}}});const me=ne(de,[["__scopeId","data-v-5c407845"]]);export{me as default};
