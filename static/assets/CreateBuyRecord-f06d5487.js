import{x as ee,d as ue,r as p,y as de,w as oe,o as ie,b as H,e as o,E as c,g as s,h as me,i as b,j as U,k as l,l as f,s as G,a as h,m as j,p as pe,z as we,_ as ce,c as Z,u as Re,f as ke,t as $,F as ne,A as se,n as Ue,v as re}from"./index-2179ff4f.js";import{u as xe,c as Ae}from"./buys-0e9130bb.js";const Ye=(x={})=>ee.get("/search/assets",{params:x}),fe=x=>ee.get("/assets/accounts",{params:{userid:x}}),De=(x,P)=>ee.post("/assets/accounts",P,{params:{userid:x}}),Se={key:0,class:"account-list"},Te={class:"header-actions"},Be={key:0,class:"empty-state"},Pe={class:"dialog-footer"},Ne=ue({__name:"AccountDialog",props:{visible:{type:Boolean},userid:{}},emits:["select","close","update:visible"],setup(x,{emit:P}){const J=P,N=x,v=p(N.visible),g=p("select"),w=p(!1),D=p(!1),_=p([]),V=p(),y=de({name:"",manager:"",desc:""}),i={name:[{required:!0,message:"请输入账户名称",trigger:"blur"}],manager:[{required:!0,message:"请输入管理人",trigger:"blur"}],desc:[{max:500,message:"描述不能超过500个字符",trigger:"blur"}]};oe(()=>N.visible,d=>{v.value=d,d&&g.value==="select"&&S()}),oe(v,d=>{d||J("update:visible",!1)});const A=d=>new Date(d).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),S=async()=>{var d,a;try{w.value=!0;const m=await fe(N.userid);m.success?_.value=m.data:c.error(m.message||"获取账户列表失败")}catch(m){c.error(((a=(d=m.response)==null?void 0:d.data)==null?void 0:a.message)||"获取账户列表失败")}finally{w.value=!1}},T=()=>{g.value="create"},Q=d=>{J("select",d),v.value=!1},q=async()=>{var d,a;if(V.value)try{await V.value.validate(),D.value=!0;const m=await De(N.userid,y);m.success?(c.success("账户创建成功"),g.value="select",await S()):c.error(m.message||"创建账户失败")}catch(m){c.error(((a=(d=m.response)==null?void 0:d.data)==null?void 0:a.message)||"创建账户失败")}finally{D.value=!1}},B=()=>{g.value="select",V.value&&V.value.resetFields()};return ie(()=>{v.value&&S()}),(d,a)=>{const m=s("el-icon"),Y=s("el-button"),O=s("el-table-column"),K=s("el-table"),F=s("el-empty"),z=s("el-input"),L=s("el-form-item"),W=s("el-form"),X=s("el-dialog"),u=me("loading");return b(),H(X,{modelValue:v.value,"onUpdate:modelValue":a[4]||(a[4]=e=>v.value=e),title:g.value==="select"?"选择资金账户":"新增资金账户",width:"600px","destroy-on-close":"",onClosed:B},{footer:o(()=>[U("span",Pe,[l(Y,{onClick:a[3]||(a[3]=e=>v.value=!1)},{default:o(()=>a[6]||(a[6]=[f("取消")])),_:1,__:[6]}),g.value==="create"?(b(),H(Y,{key:0,type:"primary",onClick:q,loading:D.value},{default:o(()=>a[7]||(a[7]=[f(" 创建 ")])),_:1,__:[7]},8,["loading"])):G("",!0)])]),default:o(()=>[g.value==="select"?(b(),h("div",Se,[U("div",Te,[l(Y,{type:"primary",onClick:T},{default:o(()=>[l(m,null,{default:o(()=>[l(j(we))]),_:1}),a[5]||(a[5]=f(" 新增账户 "))]),_:1,__:[5]})]),pe((b(),H(K,{data:_.value,style:{width:"100%"},onRowClick:Q},{default:o(()=>[l(O,{prop:"name",label:"账户名称",width:"150"}),l(O,{prop:"manager",label:"管理人",width:"120"}),l(O,{prop:"desc",label:"描述","show-overflow-tooltip":""}),l(O,{prop:"createdAt",label:"创建时间",width:"180",formatter:e=>A(e.createdAt)},null,8,["formatter"])]),_:1},8,["data"])),[[u,w.value]]),!w.value&&_.value.length===0?(b(),h("div",Be,[l(F,{description:"暂无账户数据"})])):G("",!0)])):(b(),H(W,{key:1,ref_key:"formRef",ref:V,model:y,rules:i,"label-width":"100px",class:"account-form"},{default:o(()=>[l(L,{label:"账户名称",prop:"name"},{default:o(()=>[l(z,{modelValue:y.name,"onUpdate:modelValue":a[0]||(a[0]=e=>y.name=e),placeholder:"请输入账户名称"},null,8,["modelValue"])]),_:1}),l(L,{label:"管理人",prop:"manager"},{default:o(()=>[l(z,{modelValue:y.manager,"onUpdate:modelValue":a[1]||(a[1]=e=>y.manager=e),placeholder:"请输入管理人"},null,8,["modelValue"])]),_:1}),l(L,{label:"描述",prop:"desc"},{default:o(()=>[l(z,{modelValue:y.desc,"onUpdate:modelValue":a[2]||(a[2]=e=>y.desc=e),type:"textarea",rows:3,placeholder:"请输入账户描述（选填）",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]))]),_:1},8,["modelValue","title"])}}});const qe=ce(Ne,[["__scopeId","data-v-6139db91"]]),Oe={class:"create-buy-record"},Ee={class:"card-header"},Me={class:"asset-select"},$e={class:"account-select"},He={class:"dialog-search"},he={key:0,class:"empty-state"},Fe={class:"dialog-pagination"},ze={class:"dialog-footer"},Le=ue({__name:"CreateBuyRecord",setup(x){const P={1:"CNY",4:"THB",7:"USD"},J={2:"ETF",4:"数字货币",8:"外汇"},N=[{label:"种菜",value:1},{label:"种果树",value:2},{label:"钓鱼",value:3},{label:"捡馅饼",value:4},{label:"狩猎",value:5},{label:"生态位",value:6}],v=Re(),g=ke(),w=p(!1),D=p(),_=Z(()=>Number(v.params.userId)),V=Z(()=>v.params.id!==void 0);Z(()=>Number(v.params.id));const y=p(new Set),i=u=>{y.value.add(u)},A=p(!1),S=p(""),T=p(1),Q=p(0),q=p(!1),B=p([]),d=p(),a=de({buyTime:"",assetId:void 0,currencyId:void 0,exchangeRate:1,price:0,amount:0,amountOri:void 0,strategy:void 0,totalPay:void 0,feeRate:void 0,fee:void 0,accountId:void 0,financing:!1,financeRate:void 0,dividendYield:void 0,desc:""}),m=p(!1),Y=p(),O={buyTime:[{required:!0,message:"请选择购买时间",trigger:"change"}],assetId:[{required:!0,message:"请选择品种",trigger:"change"}],currencyId:[{required:!0,message:"请选择币种",trigger:"change"}],exchangeRate:[{required:!0,message:"请输入汇率",trigger:"blur"},{type:"number",min:0,message:"汇率必须大于0",trigger:"blur"}],price:[{required:!0,message:"请输入买进价格",trigger:"blur"},{type:"number",min:0,message:"买进价格必须大于0",trigger:"blur"}],amount:[{required:!0,message:"请输入数量",trigger:"blur"},{type:"number",min:0,message:"数量必须大于0",trigger:"blur"}],strategy:[{required:!0,message:"请选择策略",trigger:"change"}]},K=async()=>{var u,e;try{q.value=!0;const r=await Ye({query:S.value,page:T.value});r.success?B.value=r.data:(c.error(r.message||"获取品种列表失败"),B.value=[])}catch(r){c.error(((e=(u=r.response)==null?void 0:u.data)==null?void 0:e.message)||"获取品种列表失败"),B.value=[]}finally{q.value=!1}},F=()=>{T.value=1,K()},z=u=>{T.value=u,K()},L=u=>{d.value=u,a.assetId=u.id,a.currencyId=u.currency,A.value=!1,i("assetId"),i("currencyId")},W=u=>{Y.value=u,a.accountId=u.id,m.value=!1,i("accountId")},X=async()=>{var u,e,r,R;if(D.value)try{await D.value.validate(),w.value=!0;const n={...a,assetId:(u=d.value)==null?void 0:u.id,accountId:(e=Y.value)==null?void 0:e.id};if(V.value){const C={id:Number(v.params.id),assetId:n.assetId,currencyId:n.currencyId};if(y.value.size===0){c.warning("您还没有做任何修改"),w.value=!1;return}y.value.forEach(E=>{E in n&&(C[E]=n[E])}),console.log("更新数据:",C);const I=await xe(_.value,C);I.success?(c.success("记录更新成功"),g.push({name:"UserBuyHistory",params:{userId:_.value}})):c.error(I.message||"更新失败")}else{if(!n.assetId){c.error("请选择资产");return}const C={buyTime:n.buyTime,assetId:n.assetId,currencyId:n.currencyId,exchangeRate:n.exchangeRate,price:n.price,amount:n.amount,amountOri:n.amountOri,strategy:n.strategy,totalPay:n.totalPay,feeRate:n.feeRate,fee:n.fee,accountId:n.accountId,financing:n.financing,financeRate:n.financeRate,dividendYield:n.dividendYield,desc:n.desc},I=await Ae(_.value,C);I.success?(c.success("记录创建成功"),g.push({name:"UserBuyHistory",params:{userId:_.value}})):c.error(I.message||"创建失败")}}catch(n){c.error(((R=(r=n.response)==null?void 0:r.data)==null?void 0:R.message)||"操作失败")}finally{w.value=!1}};return ie(async()=>{var u;if(V.value){const e=sessionStorage.getItem("editBuyRecord"),r=e?JSON.parse(e):void 0;if(!r){c.error("获取记录数据失败"),g.replace(`/dashboard/users/${_.value}/buy-history`);return}if(Object.assign(a,r),r.assetId&&(d.value={id:r.assetId,name:((u=r.assets)==null?void 0:u.name)||"",currency:r.currencyId}),r.accountId)try{const R=await fe(_.value);if(R.success){const n=R.data.find(C=>C.id===r.accountId);n&&(Y.value=n)}}catch(R){console.error("加载账户信息失败:",R)}sessionStorage.removeItem("editBuyRecord")}}),(u,e)=>{const r=s("el-button"),R=s("el-date-picker"),n=s("el-form-item"),C=s("el-icon"),I=s("el-input"),E=s("el-option"),le=s("el-select"),k=s("el-input-number"),ae=s("el-radio"),ge=s("el-radio-group"),ve=s("el-form"),_e=s("el-card"),M=s("el-table-column"),ye=s("el-table"),be=s("el-empty"),Ve=s("el-pagination"),Ce=s("el-dialog"),Ie=me("loading");return b(),h("div",Oe,[l(_e,{class:"create-buy-record"},{header:o(()=>[U("div",Ee,[U("span",null,$(V.value?"编辑买进记录":"新增买进记录"),1),l(r,{onClick:e[0]||(e[0]=t=>j(g).back())},{default:o(()=>e[39]||(e[39]=[f("返回")])),_:1,__:[39]})])]),default:o(()=>[l(ve,{ref_key:"formRef",ref:D,model:a,rules:O,"label-width":"120px",class:"buy-record-form"},{default:o(()=>[l(n,{label:"购买时间",prop:"buyTime"},{default:o(()=>[l(R,{modelValue:a.buyTime,"onUpdate:modelValue":e[1]||(e[1]=t=>a.buyTime=t),type:"datetime",placeholder:"选择日期时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",onChange:e[2]||(e[2]=()=>i("buyTime"))},null,8,["modelValue"])]),_:1}),l(n,{label:"资产",prop:"assetId"},{default:o(()=>{var t;return[U("div",Me,[l(I,{"model-value":((t=d.value)==null?void 0:t.name)||"",placeholder:"请选择资产",readonly:"",onClick:e[4]||(e[4]=()=>A.value=!0)},{append:o(()=>[l(r,{onClick:e[3]||(e[3]=()=>A.value=!0)},{default:o(()=>[l(C,null,{default:o(()=>[l(j(re))]),_:1})]),_:1})]),_:1},8,["model-value"])])]}),_:1}),l(n,{label:"币种",prop:"currencyId"},{default:o(()=>[l(le,{modelValue:a.currencyId,"onUpdate:modelValue":e[5]||(e[5]=t=>a.currencyId=t),placeholder:"请选择币种",onChange:e[6]||(e[6]=()=>i("currencyId"))},{default:o(()=>[(b(),h(ne,null,se(P,(t,te)=>l(E,{key:te,label:t,value:Number(te)},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),l(n,{label:"汇率",prop:"exchangeRate"},{default:o(()=>[l(k,{modelValue:a.exchangeRate,"onUpdate:modelValue":e[7]||(e[7]=t=>a.exchangeRate=t),precision:4,step:1e-4,min:0,onChange:e[8]||(e[8]=()=>i("exchangeRate"))},null,8,["modelValue"])]),_:1}),l(n,{label:"价格",prop:"price"},{default:o(()=>[l(k,{modelValue:a.price,"onUpdate:modelValue":e[9]||(e[9]=t=>a.price=t),precision:3,step:.001,min:0,onChange:e[10]||(e[10]=()=>i("price"))},null,8,["modelValue"])]),_:1}),l(n,{label:"数量",prop:"amount"},{default:o(()=>[l(k,{modelValue:a.amount,"onUpdate:modelValue":e[11]||(e[11]=t=>a.amount=t),precision:4,step:1e-4,min:0,onChange:e[12]||(e[12]=()=>i("amount"))},null,8,["modelValue"])]),_:1}),l(n,{label:"原始数量",prop:"amountOri"},{default:o(()=>[l(k,{modelValue:a.amountOri,"onUpdate:modelValue":e[13]||(e[13]=t=>a.amountOri=t),precision:4,step:1e-4,min:0,onChange:e[14]||(e[14]=()=>i("amountOri"))},null,8,["modelValue"])]),_:1}),l(n,{label:"策略",prop:"strategy"},{default:o(()=>[l(le,{modelValue:a.strategy,"onUpdate:modelValue":e[15]||(e[15]=t=>a.strategy=t),placeholder:"请选择策略",onChange:e[16]||(e[16]=()=>i("strategy"))},{default:o(()=>[(b(),h(ne,null,se(N,t=>l(E,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),l(n,{label:"总支付",prop:"totalPay"},{default:o(()=>[l(k,{modelValue:a.totalPay,"onUpdate:modelValue":e[17]||(e[17]=t=>a.totalPay=t),precision:2,step:.01,min:0,onChange:e[18]||(e[18]=()=>i("totalPay"))},null,8,["modelValue"])]),_:1}),l(n,{label:"手续费率",prop:"feeRate"},{default:o(()=>[l(k,{modelValue:a.feeRate,"onUpdate:modelValue":e[19]||(e[19]=t=>a.feeRate=t),precision:4,step:1e-4,min:0,onChange:e[20]||(e[20]=()=>i("feeRate"))},null,8,["modelValue"])]),_:1}),l(n,{label:"手续费",prop:"fee"},{default:o(()=>[l(k,{modelValue:a.fee,"onUpdate:modelValue":e[21]||(e[21]=t=>a.fee=t),precision:2,step:.01,min:0,onChange:e[22]||(e[22]=()=>i("fee"))},null,8,["modelValue"])]),_:1}),l(n,{label:"资金账户",prop:"accountId"},{default:o(()=>{var t;return[U("div",$e,[l(I,{"model-value":((t=Y.value)==null?void 0:t.name)||"",placeholder:"请选择资金账户",readonly:"",onClick:e[24]||(e[24]=()=>m.value=!0)},{append:o(()=>[l(r,{onClick:e[23]||(e[23]=()=>m.value=!0)},{default:o(()=>e[40]||(e[40]=[f(" 选择账户 ")])),_:1,__:[40]})]),_:1},8,["model-value"])])]}),_:1}),l(n,{label:"是否融资",prop:"financing"},{default:o(()=>[l(ge,{modelValue:a.financing,"onUpdate:modelValue":e[25]||(e[25]=t=>a.financing=t),onChange:e[26]||(e[26]=()=>i("financing"))},{default:o(()=>[l(ae,{value:!0},{default:o(()=>e[41]||(e[41]=[f("是")])),_:1,__:[41]}),l(ae,{value:!1},{default:o(()=>e[42]||(e[42]=[f("否")])),_:1,__:[42]})]),_:1},8,["modelValue"])]),_:1}),a.financing?(b(),H(n,{key:0,label:"融资利率",prop:"financeRate"},{default:o(()=>[l(k,{modelValue:a.financeRate,"onUpdate:modelValue":e[27]||(e[27]=t=>a.financeRate=t),precision:4,step:1e-4,min:0,onChange:e[28]||(e[28]=()=>i("financeRate"))},null,8,["modelValue"])]),_:1})):G("",!0),l(n,{label:"股息率",prop:"dividendYield"},{default:o(()=>[l(k,{modelValue:a.dividendYield,"onUpdate:modelValue":e[29]||(e[29]=t=>a.dividendYield=t),precision:4,step:1e-4,min:0,onChange:e[30]||(e[30]=()=>i("dividendYield"))},null,8,["modelValue"])]),_:1}),l(n,{label:"描述",prop:"desc"},{default:o(()=>[l(I,{modelValue:a.desc,"onUpdate:modelValue":e[31]||(e[31]=t=>a.desc=t),type:"textarea",rows:3,placeholder:"请输入描述",onInput:e[32]||(e[32]=()=>i("desc"))},null,8,["modelValue"])]),_:1}),l(n,null,{default:o(()=>[l(r,{type:"primary",onClick:X,loading:w.value},{default:o(()=>[f($(V.value?"保存修改":"新增记录"),1)]),_:1},8,["loading"]),l(r,{onClick:e[33]||(e[33]=()=>j(g).push({name:"UserBuyHistory",params:{userId:_.value.value}}))},{default:o(()=>e[43]||(e[43]=[f("取消")])),_:1,__:[43]})]),_:1})]),_:1},8,["model"])]),_:1}),l(Ce,{modelValue:A.value,"onUpdate:modelValue":e[37]||(e[37]=t=>A.value=t),title:"选择品种",width:"60%","destroy-on-close":""},{footer:o(()=>[U("span",ze,[l(r,{onClick:e[36]||(e[36]=t=>A.value=!1)},{default:o(()=>e[44]||(e[44]=[f("取消")])),_:1,__:[44]})])]),default:o(()=>[U("div",He,[l(I,{modelValue:S.value,"onUpdate:modelValue":e[34]||(e[34]=t=>S.value=t),placeholder:"搜索品种代码或名称",clearable:"",onClear:F,onKeyup:Ue(F,["enter"])},{append:o(()=>[l(r,{onClick:F},{default:o(()=>[l(C,null,{default:o(()=>[l(j(re))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),pe((b(),H(ye,{data:B.value,style:{width:"100%"},onRowClick:L},{default:o(()=>[l(M,{prop:"code",label:"品种代码",width:"150"}),l(M,{prop:"name",label:"品种名称",width:"180"}),l(M,{label:"类型",width:"100"},{default:o(t=>[f($(J[t.row.atype]||"-"),1)]),_:1}),l(M,{prop:"category",label:"分类",width:"120"},{default:o(t=>[f($(t.row.category||"-"),1)]),_:1}),l(M,{label:"当前价格",width:"120",align:"right"},{default:o(t=>[f($(t.row.price>=0?t.row.price.toFixed(3):"-"),1)]),_:1}),l(M,{label:"币种",width:"80"},{default:o(t=>[f($(P[t.row.currency]||"-"),1)]),_:1})]),_:1},8,["data"])),[[Ie,q.value]]),!q.value&&B.value.length===0?(b(),h("div",he,[l(be,{description:"暂无数据"})])):G("",!0),U("div",Fe,[l(Ve,{"current-page":T.value,"onUpdate:currentPage":e[35]||(e[35]=t=>T.value=t),total:Q.value,"page-size":10,background:"",layout:"prev, pager, next",onCurrentChange:z},null,8,["current-page","total"])])]),_:1},8,["modelValue"]),l(qe,{visible:m.value,userid:_.value,"onUpdate:visible":e[38]||(e[38]=t=>m.value=t),onSelect:W},null,8,["visible","userid"])])}}});const Ke=ce(Le,[["__scopeId","data-v-5db51a23"]]);export{Ke as default};
