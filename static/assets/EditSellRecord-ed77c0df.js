import{d as G,r as c,o as W,g as s,i as F,a as H,j as J,k as o,e as i,l as d,n as re,t as V,m as O,E as I,_ as L,c as M,D as ne,w as ue,u as se,f as de,b as K,s as A,F as ge}from"./index-2179ff4f.js";import{u as pe,c as ve,a as ce}from"./sells-ee34ea61.js";import{s as me}from"./buys-0e9130bb.js";const j=(y,U)=>y==null?"-":y.toFixed(U),fe=y=>(typeof y=="string"?new Date(y):y).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),be={1:"CNY",2:"USD",3:"HKD",4:"EUR",5:"GBP",6:"JPY",7:"KRW",8:"TWD"},Re={class:"buy-record-selector"},ye={class:"search-bar"},_e={class:"pagination"},he={class:"dialog-footer"},Ie=G({__name:"BuyRecordSelector",props:{userid:{}},emits:["select","cancel"],setup(y,{emit:U}){const $=y,_=U,D=c(""),T=c(1),k=c(10),w=c(0),m=c([]),S=async()=>{try{const p=await me({userid:$.userid,query:D.value,page:T.value});if(p.success&&p.data){const v=p.data;w.value=v.length;const t=(T.value-1)*k.value,N=t+k.value;m.value=v.slice(t,N)}else I.error(p.message||"加载买入记录失败")}catch(p){console.error("加载买入记录失败:",p),I.error("加载买入记录失败")}},q=()=>{T.value=1,S()},u=p=>{T.value=p,S()},C=p=>{_("select",p)};return W(()=>{S()}),(p,v)=>{const t=s("el-button"),N=s("el-input"),E=s("el-table-column"),B=s("el-table"),Y=s("el-pagination");return F(),H("div",Re,[J("div",ye,[o(N,{modelValue:D.value,"onUpdate:modelValue":v[0]||(v[0]=f=>D.value=f),placeholder:"搜索资产名称",clearable:"",onClear:q,onKeyup:re(q,["enter"])},{append:i(()=>[o(t,{onClick:q},{default:i(()=>v[3]||(v[3]=[d(" 搜索 ")])),_:1,__:[3]})]),_:1},8,["modelValue"])]),o(B,{data:m.value,style:{width:"100%"},height:"400px",onRowClick:C},{default:i(()=>[o(E,{prop:"assets.name",label:"资产名称"}),o(E,{prop:"price",label:"买入价格"},{default:i(({row:f})=>[d(V(O(j)(f.price,3)),1)]),_:1}),o(E,{prop:"amount",label:"买入数量"},{default:i(({row:f})=>[d(V(O(j)(f.amount,4)),1)]),_:1}),o(E,{prop:"currencyId",label:"币种"},{default:i(({row:f})=>[d(V(O(be)[f.currencyId]),1)]),_:1}),o(E,{prop:"buyTime",label:"买入时间"},{default:i(({row:f})=>[d(V(O(fe)(f.buyTime)),1)]),_:1})]),_:1},8,["data"]),J("div",_e,[o(Y,{"current-page":T.value,"onUpdate:currentPage":v[1]||(v[1]=f=>T.value=f),"page-size":k.value,total:w.value,layout:"total, prev, pager, next",onCurrentChange:u},null,8,["current-page","page-size","total"])]),J("div",he,[o(t,{onClick:v[2]||(v[2]=f=>p.$emit("cancel"))},{default:i(()=>v[4]||(v[4]=[d("取消")])),_:1,__:[4]})])])}}});const Ve=L(Ie,[["__scopeId","data-v-8de7af03"]]),Te={class:"edit-sell-record"},we={class:"card-header"},Se=G({__name:"EditSellRecord",setup(y){const U={1:"CNY",2:"USD",3:"EUR",4:"GBP",5:"JPY",6:"USDT",7:"USDC"},$=(l,e=2)=>l==null?"-":l.toFixed(e),_=se(),D=de(),T=c();c(!1);const k=c(!1),w=c(!1),m=c(null),S=c(new Set),q=c({}),u=l=>{S.value.add(l)},C=M(()=>Number(_.params.userId));M(()=>Number(_.params.id));const p=M(()=>!!_.params.id),v=M(()=>{const l=_.params.userId;return console.log("Route params userid:",_.params.userId),console.log("Selected userid:",l),typeof l=="string"?parseInt(l,10):0}),t=c({sellTime:"",assetId:0,buysId:0,currencyId:0,exchangeRate:0,sellPrice:0,amount:0,feeRate:0,fee:0,distributionType:0,distributionId:0,fishingRatio:0,fruitRatio:0,vegetableRatio:0,huntingRatio:0,ecologyRatio:0,pieRatio:0}),N=l=>{m.value=l,t.value.buysId=l.id,t.value.assetId=l.assetId,t.value.currencyId=l.currencyId,t.value.exchangeRate=l.exchangeRate,w.value=!1},E=M(()=>{var l;return m.value?`${((l=m.value.assets)==null?void 0:l.name)||"-"} - ${$(m.value.price,3)} ${U[m.value.currencyId]}`:""}),B=()=>{D.push({name:"UserSellHistory",params:{userId:C.value.toString()}})},Y=async l=>{var e;if(console.log("开始提交表单"),!l){console.log("formEl不存在");return}try{console.log("开始验证表单");const a=await l.validate();if(console.log("表单验证结果:",a),a){if(t.value.distributionType===1&&!X()){I.error("所有比例之和必须等于100");return}try{if(k.value=!0,console.log("提交的表单数据:",t.value),_.params.id){console.log("更新记录");const g={id:Number(_.params.id),assetId:t.value.assetId,buysId:t.value.buysId,currencyId:t.value.currencyId};if(S.value.size===0){I.warning("您还没有做任何修改");return}const n={...g};S.value.forEach(x=>{x in t.value&&(x==="distributionType"?n[x]=t.value.distributionType-1:n[x]=t.value[x])}),console.log("更新数据:",n),console.log("修改的字段:",Array.from(S.value));const R=await pe(C.value,n);if(console.log("更新响应:",R),R.success)I.success("更新成功"),D.push({name:"UserSellHistory",params:{userId:C.value.toString()}});else throw new Error(R.message)}else{console.log("创建新记录");const g=await ve(C.value,{...t.value,distributionType:t.value.distributionType-1});if(console.log("创建响应:",g),g.success)I.success("创建成功"),D.push({name:"UserSellHistory",params:{userId:C.value.toString()}});else throw new Error(g.message)}}catch(g){console.error("操作失败:",g),console.error("错误详情:",(e=g.response)==null?void 0:e.data),I.error(g.message||"操作失败")}finally{k.value=!1}}else console.log("表单验证失败")}catch(a){console.error("表单验证出错:",a)}};W(async()=>{if(_.params.id){const l=sessionStorage.getItem("editSellRecord"),e=l?JSON.parse(l):void 0;if(!e){I.error("获取记录数据失败"),B();return}console.log("从sessionStorage获取的记录数据:",e);try{if(Object.assign(t.value,{sellTime:e.sellTime,assetId:e.assetId,buysId:e.buysId,currencyId:e.currencyId,exchangeRate:e.exchangeRate,sellPrice:e.sellPrice,amount:e.amount,feeRate:e.feeRate||0,fee:e.fee||0,distributionType:(e.distributionType||0)+1,distributionId:e.distributionId||0,vegetableRatio:e.vegetableRatio||0,fruitRatio:e.fruitRatio||0,fishingRatio:e.fishingRatio||0,pieRatio:e.pieRatio||0,huntingRatio:e.huntingRatio||0,ecologyRatio:e.ecologyRatio||0}),q.value=JSON.parse(JSON.stringify(t.value)),S.value.clear(),t.value.distributionType===2&&(console.log("检测到定向分配，设置分配目标"),console.log("各比例值:",{fruitRatio:e.fruitRatio,fishingRatio:e.fishingRatio,vegetableRatio:e.vegetableRatio,huntingRatio:e.huntingRatio,ecologyRatio:e.ecologyRatio,pieRatio:e.pieRatio}),ne(()=>{if(Math.abs((e.fruitRatio||0)-100)<.01)b.value="fruit",console.log("设置定向分配目标为: fruit");else if(Math.abs((e.fishingRatio||0)-100)<.01)b.value="fishing",console.log("设置定向分配目标为: fishing");else if(Math.abs((e.vegetableRatio||0)-100)<.01)b.value="vegetable",console.log("设置定向分配目标为: vegetable");else if(Math.abs((e.huntingRatio||0)-100)<.01)b.value="hunting",console.log("设置定向分配目标为: hunting");else if(Math.abs((e.ecologyRatio||0)-100)<.01)b.value="ecology",console.log("设置定向分配目标为: ecology");else if(Math.abs((e.pieRatio||0)-100)<.01)b.value="pie",console.log("设置定向分配目标为: pie");else{const g=[{key:"fruit",value:e.fruitRatio||0},{key:"fishing",value:e.fishingRatio||0},{key:"vegetable",value:e.vegetableRatio||0},{key:"hunting",value:e.huntingRatio||0},{key:"ecology",value:e.ecologyRatio||0},{key:"pie",value:e.pieRatio||0}].reduce((n,R)=>R.value>n.value?R:n);g.value>0?(b.value=g.key,console.log("未找到100%的比例，设置最大比例为定向分配目标:",g.key,g.value)):console.log("未找到任何有效的比例，无法确定定向分配目标")}console.log("最终设置的定向分配目标:",b.value)})),e.buys){const a=e.buys;m.value={id:a.id,assetId:a.assetId,assets:a.assets||e.assets,userId:e.userId||0,currencyId:a.currencyId,exchangeRate:a.exchangeRate,price:a.price,amount:a.amount,amountOri:a.amount,buyTime:a.buyTime||new Date().toISOString(),strategy:void 0}}console.log("表单数据初始化完成:",t.value),sessionStorage.removeItem("editSellRecord")}catch(a){console.error("处理记录数据失败:",a),I.error("数据处理失败"),B()}}});const f=async()=>{try{const l=await ce(C.value);if(console.log("API Response:",l),!l||!l.data)throw console.error("Invalid response:",l),new Error("获取分配比例失败: 无效的响应");const{distribution:e}=l.data;if(e)console.log("Setting distribution values:",e),t.value.vegetableRatio=e.vegetable,t.value.fruitRatio=e.fruitTree,t.value.fishingRatio=e.fishing,t.value.pieRatio=e.pie,t.value.huntingRatio=e.hunting,t.value.ecologyRatio=e.ecology,t.value.distributionId=e.id,u("vegetableRatio"),u("fruitRatio"),u("fishingRatio"),u("pieRatio"),u("huntingRatio"),u("ecologyRatio"),u("distributionId");else throw console.error("Distribution object is null or undefined"),new Error("没有找到分配比例配置")}catch(l){console.error("获取分配比例失败，完整错误信息:",l),l.response&&(console.error("Error response:",l.response),console.error("Error response data:",l.response.data)),I.error(l.message||"获取分配比例失败")}},b=c(""),Q=l=>{switch(console.log("选择定向分配目标:",l),t.value.vegetableRatio=0,t.value.fruitRatio=0,t.value.fishingRatio=0,t.value.pieRatio=0,t.value.huntingRatio=0,t.value.ecologyRatio=0,l){case"fruit":t.value.fruitRatio=100;break;case"fishing":t.value.fishingRatio=100;break;case"vegetable":t.value.vegetableRatio=100;break;case"hunting":t.value.huntingRatio=100;break;case"ecology":t.value.ecologyRatio=100;break;case"pie":t.value.pieRatio=100;break}u("vegetableRatio"),u("fruitRatio"),u("fishingRatio"),u("pieRatio"),u("huntingRatio"),u("ecologyRatio")};ue(()=>t.value.distributionType,(l,e)=>{e!==void 0&&(l===1?(b.value="",f()):(t.value.vegetableRatio=0,t.value.fruitRatio=0,t.value.fishingRatio=0,t.value.pieRatio=0,t.value.huntingRatio=0,t.value.ecologyRatio=0,b.value=""))});const X=()=>{if(t.value.distributionType===1){const l=(t.value.vegetableRatio||0)+(t.value.fruitRatio||0)+(t.value.fishingRatio||0)+(t.value.pieRatio||0)+(t.value.huntingRatio||0)+(t.value.ecologyRatio||0);return console.log("验证总和:",l),Math.abs(l-100)<1e-4}else if(t.value.distributionType===2){const l=(t.value.vegetableRatio||0)+(t.value.fruitRatio||0)+(t.value.fishingRatio||0)+(t.value.pieRatio||0)+(t.value.huntingRatio||0)+(t.value.ecologyRatio||0);return console.log("定向分配总和:",l),Math.abs(l-100)<1e-4&&b.value!==""}return!0},Z=c({sellTime:[{required:!0,message:"请选择卖出时间",trigger:"change"}],buysId:[{required:!0,message:"请选择买入记录",trigger:"change"}],currencyId:[{required:!0,message:"请选择币种",trigger:"change"}],exchangeRate:[{required:!0,message:"请输入汇率",trigger:"blur"},{type:"number",min:0,message:"汇率必须大于等于0",trigger:"blur"}],sellPrice:[{required:!0,message:"请输入卖出价格",trigger:"blur"},{type:"number",min:0,message:"卖出价格必须大于等于0",trigger:"blur"}],amount:[{required:!0,message:"请输入数量",trigger:"blur"},{type:"number",min:0,message:"数量必须大于等于0",trigger:"blur"}],feeRate:[{required:!0,message:"请输入手续费率",trigger:"blur"},{type:"number",min:0,message:"手续费率必须大于等于0",trigger:"blur"}],fee:[{required:!0,message:"请输入手续费",trigger:"blur"},{type:"number",min:0,message:"手续费必须大于等于0",trigger:"blur"}],distributionType:[{required:!0,message:"请选择分配类型",trigger:"change"},{type:"number",min:1,message:"请选择分配类型",trigger:"change"}],distributionId:[{required:!0,message:"请输入分配ID",trigger:"blur"},{type:"number",min:1,message:"分配ID必须大于等于1",trigger:"blur"}],fishingRatio:[{required:!0,validator:(l,e,a)=>{t.value.distributionType===1&&(e==null?a(new Error("请输入捕鱼比例")):(e<0||e>100)&&a(new Error("比例必须在0-100之间"))),a()},trigger:"blur"}],fruitRatio:[{required:!0,validator:(l,e,a)=>{t.value.distributionType===1&&(e==null?a(new Error("请输入种果树比例")):(e<0||e>100)&&a(new Error("比例必须在0-100之间"))),a()},trigger:"blur"}],vegetableRatio:[{required:!0,validator:(l,e,a)=>{t.value.distributionType===1&&(e==null?a(new Error("请输入种菜比例")):(e<0||e>100)&&a(new Error("比例必须在0-100之间"))),a()},trigger:"blur"}],huntingRatio:[{required:!0,validator:(l,e,a)=>{t.value.distributionType===1&&(e==null?a(new Error("请输入狩猎比例")):(e<0||e>100)&&a(new Error("比例必须在0-100之间"))),a()},trigger:"blur"}],ecologyRatio:[{required:!0,validator:(l,e,a)=>{t.value.distributionType===1&&(e==null?a(new Error("请输入生态比例")):(e<0||e>100)&&a(new Error("比例必须在0-100之间"))),a()},trigger:"blur"}],pieRatio:[{required:!0,validator:(l,e,a)=>{t.value.distributionType===1&&(e==null?a(new Error("请输入派比例")):(e<0||e>100)&&a(new Error("比例必须在0-100之间"))),a()},trigger:"blur"}]});return(l,e)=>{const a=s("el-button"),g=s("el-input"),n=s("el-form-item"),R=s("el-descriptions-item"),x=s("el-descriptions"),ee=s("el-date-picker"),h=s("el-input-number"),z=s("el-option"),te=s("el-select"),P=s("el-radio"),oe=s("el-radio-group"),le=s("el-form"),ae=s("el-dialog"),ie=s("el-card");return F(),H("div",Te,[o(ie,null,{header:i(()=>[J("div",we,[J("span",null,V(p.value?"编辑卖出记录":"新增卖出记录"),1)])]),default:i(()=>[o(le,{ref_key:"formRef",ref:T,model:t.value,rules:Z.value,"label-width":"120px",class:"sell-record-form"},{default:i(()=>[o(n,{label:"买入记录",prop:"buysId"},{default:i(()=>[o(g,{modelValue:E.value,"onUpdate:modelValue":e[1]||(e[1]=r=>E.value=r),placeholder:"请选择买入记录",readonly:"",onClick:e[2]||(e[2]=r=>w.value=!0)},{append:i(()=>[o(a,{onClick:e[0]||(e[0]=r=>w.value=!0)},{default:i(()=>e[25]||(e[25]=[d(" 选择 ")])),_:1,__:[25]})]),_:1},8,["modelValue"])]),_:1}),m.value?(F(),K(x,{key:0,title:"买入记录详情",column:2,border:""},{default:i(()=>[o(R,{label:"资产名称"},{default:i(()=>{var r;return[d(V(((r=m.value.assets)==null?void 0:r.name)||"-"),1)]}),_:1}),o(R,{label:"买入价格"},{default:i(()=>[d(V($(m.value.price,3)),1)]),_:1}),o(R,{label:"买入数量"},{default:i(()=>[d(V($(m.value.amount,4)),1)]),_:1}),o(R,{label:"币种"},{default:i(()=>[d(V(U[m.value.currencyId]),1)]),_:1})]),_:1})):A("",!0),o(n,{label:"卖出时间",prop:"sellTime"},{default:i(()=>[o(ee,{modelValue:t.value.sellTime,"onUpdate:modelValue":e[3]||(e[3]=r=>t.value.sellTime=r),type:"datetime",placeholder:"选择卖出时间",onChange:e[4]||(e[4]=r=>u("sellTime"))},null,8,["modelValue"])]),_:1}),o(n,{label:"卖出价格",prop:"sellPrice"},{default:i(()=>[o(h,{modelValue:t.value.sellPrice,"onUpdate:modelValue":e[5]||(e[5]=r=>t.value.sellPrice=r),precision:3,step:.001,min:0,onChange:e[6]||(e[6]=r=>u("sellPrice"))},null,8,["modelValue"])]),_:1}),o(n,{label:"卖出数量",prop:"amount"},{default:i(()=>[o(h,{modelValue:t.value.amount,"onUpdate:modelValue":e[7]||(e[7]=r=>t.value.amount=r),precision:4,step:1e-4,min:0,onChange:e[8]||(e[8]=r=>u("amount"))},null,8,["modelValue"])]),_:1}),o(n,{label:"手续费率",prop:"feeRate"},{default:i(()=>[o(h,{modelValue:t.value.feeRate,"onUpdate:modelValue":e[9]||(e[9]=r=>t.value.feeRate=r),precision:4,step:1e-4,min:0,onChange:e[10]||(e[10]=r=>u("feeRate"))},null,8,["modelValue"])]),_:1}),o(n,{label:"手续费",prop:"fee"},{default:i(()=>[o(h,{modelValue:t.value.fee,"onUpdate:modelValue":e[11]||(e[11]=r=>t.value.fee=r),precision:4,step:1e-4,min:0,onChange:e[12]||(e[12]=r=>u("fee"))},null,8,["modelValue"])]),_:1}),o(n,{label:"分配类型",prop:"distributionType"},{default:i(()=>[o(te,{modelValue:t.value.distributionType,"onUpdate:modelValue":e[13]||(e[13]=r=>t.value.distributionType=r),placeholder:"选择分配类型",onChange:e[14]||(e[14]=r=>u("distributionType"))},{default:i(()=>[o(z,{label:"请选择",value:0}),o(z,{label:"按比例分配",value:1}),o(z,{label:"定向分配",value:2})]),_:1},8,["modelValue"])]),_:1}),t.value.distributionType===1?(F(),H(ge,{key:1},[o(n,{label:"种果树比例"},{default:i(()=>[o(h,{modelValue:t.value.fruitRatio,"onUpdate:modelValue":e[15]||(e[15]=r=>t.value.fruitRatio=r),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),o(n,{label:"钓鱼比例"},{default:i(()=>[o(h,{modelValue:t.value.fishingRatio,"onUpdate:modelValue":e[16]||(e[16]=r=>t.value.fishingRatio=r),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),o(n,{label:"种菜比例"},{default:i(()=>[o(h,{modelValue:t.value.vegetableRatio,"onUpdate:modelValue":e[17]||(e[17]=r=>t.value.vegetableRatio=r),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),o(n,{label:"狩猎比例"},{default:i(()=>[o(h,{modelValue:t.value.huntingRatio,"onUpdate:modelValue":e[18]||(e[18]=r=>t.value.huntingRatio=r),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),o(n,{label:"生态位比例"},{default:i(()=>[o(h,{modelValue:t.value.ecologyRatio,"onUpdate:modelValue":e[19]||(e[19]=r=>t.value.ecologyRatio=r),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),o(n,{label:"捡馅饼比例"},{default:i(()=>[o(h,{modelValue:t.value.pieRatio,"onUpdate:modelValue":e[20]||(e[20]=r=>t.value.pieRatio=r),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1})],64)):A("",!0),t.value.distributionType===2?(F(),K(n,{key:2,label:"分配目标",prop:"directDistributionTarget"},{default:i(()=>[o(oe,{modelValue:b.value,"onUpdate:modelValue":e[21]||(e[21]=r=>b.value=r),onChange:Q},{default:i(()=>[o(P,{label:"fruit"},{default:i(()=>e[26]||(e[26]=[d("种果树")])),_:1,__:[26]}),o(P,{label:"fishing"},{default:i(()=>e[27]||(e[27]=[d("钓鱼")])),_:1,__:[27]}),o(P,{label:"vegetable"},{default:i(()=>e[28]||(e[28]=[d("种菜")])),_:1,__:[28]}),o(P,{label:"hunting"},{default:i(()=>e[29]||(e[29]=[d("狩猎")])),_:1,__:[29]}),o(P,{label:"ecology"},{default:i(()=>e[30]||(e[30]=[d("生态位")])),_:1,__:[30]}),o(P,{label:"pie"},{default:i(()=>e[31]||(e[31]=[d("捡馅饼")])),_:1,__:[31]})]),_:1},8,["modelValue"])]),_:1})):A("",!0),o(n,null,{default:i(()=>[o(a,{type:"primary",loading:k.value,onClick:e[22]||(e[22]=r=>Y(T.value))},{default:i(()=>[d(V(p.value?"保存修改":"新增记录"),1)]),_:1},8,["loading"]),o(a,{onClick:B},{default:i(()=>e[32]||(e[32]=[d("取消")])),_:1,__:[32]})]),_:1})]),_:1},8,["model","rules"]),o(ae,{modelValue:w.value,"onUpdate:modelValue":e[24]||(e[24]=r=>w.value=r),title:"选择买入记录",width:"80%","destroy-on-close":""},{default:i(()=>[o(Ve,{userid:v.value,onSelect:N,onCancel:e[23]||(e[23]=r=>w.value=!1)},null,8,["userid"])]),_:1},8,["modelValue"])]),_:1})])}}});const De=L(Se,[["__scopeId","data-v-fe93cfe3"]]);export{De as default};
