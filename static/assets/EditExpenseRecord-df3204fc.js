import{d as Q,r as _,c as E,y as W,o as X,D,a as F,k as l,e as n,u as Z,f as ee,E as p,g,i as x,j as S,t as B,l as f,q as te,F as M,A as le,s as N,b as oe,G as ae,J as re,K as ne,_ as ue}from"./index-2179ff4f.js";import{a as ie}from"./sells-ee34ea61.js";const se={class:"edit-expense-record"},de={class:"card-header"},ge=Q({__name:"EditExpenseRecord",setup(me){const $={1:"CNY",2:"USD",3:"HKD",4:"THB",5:"EUR",6:"USDT",7:"USDC"},I=Z(),H=ee(),T=_(),R=_(!1),v=E(()=>Number(I.params.userId)),y=E(()=>!!I.params.id),t=W({id:0,expensesTime:null,desc:"",category:"",currencyId:null,amount:null,exchangeRate:null,equRmb:null,deductedFrom:0,fishing:0,furitTree:0,vegetable:0,hunting:0,ecology:0,pie:0,userId:v.value}),d=_(new Set),k=_({}),V=_(""),r=s=>{d.value.add(s)},O=async()=>{var s;try{const e=await ie(v.value);if(e.success&&((s=e.data)!=null&&s.distribution)){const{distribution:u}=e.data;t.fishing=u.fishing,t.furitTree=u.fruitTree,t.vegetable=u.vegetable,t.hunting=u.hunting,t.ecology=u.ecology,t.pie=u.pie,r("fishing"),r("furitTree"),r("vegetable"),r("hunting"),r("ecology"),r("pie")}else throw new Error("没有找到分配比例配置")}catch(e){console.error("获取分配比例失败:",e),p.error("获取分配比例失败")}},C=E(()=>t.fishing+t.furitTree+t.vegetable+t.hunting+t.ecology+t.pie),j={expensesTime:[{required:!0,message:"请选择支出时间",trigger:"change"}],category:[{required:!0,message:"请选择支出类别",trigger:"change"}],currencyId:[{required:!0,message:"请选择币种",trigger:"change"}],amount:[{required:!0,message:"请输入支出金额",trigger:"blur"},{validator:(s,e,u)=>{e==null?u(new Error("请输入支出金额")):e<0?u(new Error("金额必须大于等于0")):u()},trigger:"blur"}],exchangeRate:[{required:!0,message:"请输入汇率",trigger:"blur"},{validator:(s,e,u)=>{e==null?u(new Error("请输入汇率")):e<=0?u(new Error("汇率必须大于0")):u()},trigger:"blur"}],deductedFrom:[{required:!0,message:"请选择扣除方式",trigger:"change"},{validator:(s,e,u)=>{e==null?u(new Error("请选择扣除方式")):[0,1,2].includes(e)?u():u(new Error("无效的扣除方式"))},trigger:"change"}]},z=s=>{r("deductedFrom"),s===1?O():(t.fishing=0,t.furitTree=0,t.vegetable=0,t.hunting=0,t.ecology=0,t.pie=0,r("fishing"),r("furitTree"),r("vegetable"),r("hunting"),r("ecology"),r("pie"))},A=s=>{switch(t.fishing=0,t.furitTree=0,t.vegetable=0,t.hunting=0,t.ecology=0,t.pie=0,s){case"fruit":t.furitTree=100;break;case"fishing":t.fishing=100;break;case"vegetable":t.vegetable=100;break;case"hunting":t.hunting=100;break;case"ecology":t.ecology=100;break;case"pie":t.pie=100;break}r("fishing"),r("furitTree"),r("vegetable"),r("hunting"),r("ecology"),r("pie")},J=()=>{const e=[{key:"fruit",value:t.furitTree},{key:"fishing",value:t.fishing},{key:"vegetable",value:t.vegetable},{key:"hunting",value:t.hunting},{key:"ecology",value:t.ecology},{key:"pie",value:t.pie}].find(u=>Math.abs(u.value-100)<.01);e&&(V.value=e.key)},K=()=>{if(y.value){const s=sessionStorage.getItem("editExpenseRecord");if(s)try{const e=JSON.parse(s);Object.assign(t,{id:e.id,expensesTime:new Date(e.expensesTime),desc:e.desc||"",category:e.category||"",currencyId:e.currencyId,amount:e.amount,exchangeRate:e.exchangeRate,equRmb:e.equRmb,deductedFrom:e.deductedFrom,fishing:e.fishing,furitTree:e.furitTree,vegetable:e.vegetable,hunting:e.hunting,ecology:e.ecology,pie:e.pie,userId:e.userId||v.value}),k.value={...t},t.deductedFrom===2&&D(()=>{J()}),sessionStorage.removeItem("editExpenseRecord")}catch(e){console.error("解析编辑数据失败:",e),p.error("获取编辑数据失败"),h()}else p.error("未找到编辑数据"),h()}else k.value={...t}},U=async()=>{var s,e,u;if(T.value)try{if(await T.value.validate(),t.deductedFrom===1&&Math.abs(C.value-100)>.01){p.error("策略分布比例总和必须为100%");return}if(t.deductedFrom===2){if(!V.value){p.error("请选择定向扣除目标");return}if(Math.abs(C.value-100)>.01){p.error("策略分布比例总和必须为100%");return}}if(y.value&&d.value.size===0&&await ae.confirm("您没有修改任何字段，确定要提交吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})!=="confirm")return;R.value=!0;const i={expensesTime:((s=t.expensesTime)==null?void 0:s.toISOString())||"",desc:t.desc,category:t.category,currencyId:t.currencyId||0,amount:t.amount||0,exchangeRate:t.exchangeRate||0,equRmb:t.equRmb||void 0,deductedFrom:t.deductedFrom,fishing:t.fishing,furitTree:t.furitTree,vegetable:t.vegetable,hunting:t.hunting,ecology:t.ecology,pie:t.pie,userId:t.userId};if(y.value){const o={id:t.id};d.value.has("expensesTime")&&(o.expensesTime=i.expensesTime),d.value.has("desc")&&(o.desc=i.desc),d.value.has("category")&&(o.category=i.category),d.value.has("currencyId")&&(o.currencyId=i.currencyId),d.value.has("amount")&&(o.amount=i.amount),d.value.has("exchangeRate")&&(o.exchangeRate=i.exchangeRate),d.value.has("equRmb")&&(o.equRmb=i.equRmb),d.value.has("deductedFrom")?(o.deductedFrom=i.deductedFrom,o.fishing=i.fishing,o.furitTree=i.furitTree,o.vegetable=i.vegetable,o.hunting=i.hunting,o.ecology=i.ecology,o.pie=i.pie):(d.value.has("fishing")&&(o.fishing=i.fishing),d.value.has("furitTree")&&(o.furitTree=i.furitTree),d.value.has("vegetable")&&(o.vegetable=i.vegetable),d.value.has("hunting")&&(o.hunting=i.hunting),d.value.has("ecology")&&(o.ecology=i.ecology),d.value.has("pie")&&(o.pie=i.pie)),await re(v.value,o),p.success("支出记录更新成功")}else await ne(v.value,i),p.success("支出记录创建成功");h()}catch(i){console.error("提交失败:",i),p.error(((u=(e=i.response)==null?void 0:e.data)==null?void 0:u.message)||"操作失败")}finally{R.value=!1}},h=()=>{H.push({name:"UserExpenseHistory",params:{userId:v.value.toString()}})};return X(async()=>{await D(),K()}),(s,e)=>{const u=g("el-button"),i=g("el-date-picker"),o=g("el-form-item"),c=g("el-option"),w=g("el-select"),m=g("el-input-number"),b=g("el-radio"),Y=g("el-radio-group"),G=g("el-input"),L=g("el-form"),P=g("el-card");return x(),F("div",se,[l(P,null,{header:n(()=>[S("div",de,[S("h3",null,B(y.value?"编辑支出记录":"新增支出记录"),1),l(u,{onClick:h},{default:n(()=>e[22]||(e[22]=[f("返回")])),_:1,__:[22]})])]),default:n(()=>[l(L,{ref_key:"formRef",ref:T,model:t,rules:j,"label-width":"120px",onSubmit:te(U,["prevent"])},{default:n(()=>[l(o,{label:"支出时间",prop:"expensesTime"},{default:n(()=>[l(i,{modelValue:t.expensesTime,"onUpdate:modelValue":e[0]||(e[0]=a=>t.expensesTime=a),type:"datetime",placeholder:"选择支出时间",style:{width:"100%"},onChange:e[1]||(e[1]=a=>r("expensesTime"))},null,8,["modelValue"])]),_:1}),l(o,{label:"类别",prop:"category"},{default:n(()=>[l(w,{modelValue:t.category,"onUpdate:modelValue":e[2]||(e[2]=a=>t.category=a),placeholder:"请选择支出类别",style:{width:"100%"},clearable:"",onChange:e[3]||(e[3]=a=>r("category"))},{default:n(()=>[l(c,{label:"生活支出",value:"生活支出"}),l(c,{label:"投资支出",value:"投资支出"}),l(c,{label:"债务偿还支出",value:"债务偿还支出"}),l(c,{label:"其他支出",value:"其他支出"})]),_:1},8,["modelValue"])]),_:1}),l(o,{label:"币种",prop:"currencyId"},{default:n(()=>[l(w,{modelValue:t.currencyId,"onUpdate:modelValue":e[4]||(e[4]=a=>t.currencyId=a),placeholder:"选择币种",style:{width:"100%"},clearable:"",onChange:e[5]||(e[5]=a=>r("currencyId"))},{default:n(()=>[(x(),F(M,null,le($,(a,q)=>l(c,{key:q,label:a,value:Number(q)},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),l(o,{label:"支出金额",prop:"amount"},{default:n(()=>[l(m,{modelValue:t.amount,"onUpdate:modelValue":e[6]||(e[6]=a=>t.amount=a),precision:2,min:0,step:.01,style:{width:"100%"},onChange:e[7]||(e[7]=a=>r("amount"))},null,8,["modelValue"])]),_:1}),l(o,{label:"汇率",prop:"exchangeRate"},{default:n(()=>[l(m,{modelValue:t.exchangeRate,"onUpdate:modelValue":e[8]||(e[8]=a=>t.exchangeRate=a),precision:4,min:0,step:1e-4,style:{width:"100%"},onChange:e[9]||(e[9]=a=>r("exchangeRate"))},null,8,["modelValue"])]),_:1}),l(o,{label:"等值人民币",prop:"equRmb"},{default:n(()=>[l(m,{modelValue:t.equRmb,"onUpdate:modelValue":e[10]||(e[10]=a=>t.equRmb=a),precision:2,min:0,step:.01,style:{width:"100%"},onChange:e[11]||(e[11]=a=>r("equRmb"))},null,8,["modelValue"])]),_:1}),l(o,{label:"扣除方式",prop:"deductedFrom"},{default:n(()=>[l(w,{modelValue:t.deductedFrom,"onUpdate:modelValue":e[12]||(e[12]=a=>t.deductedFrom=a),placeholder:"选择扣除方式",onChange:z},{default:n(()=>[l(c,{label:"请选择",value:0}),l(c,{label:"按比例扣除",value:1}),l(c,{label:"定向扣除",value:2})]),_:1},8,["modelValue"])]),_:1}),t.deductedFrom===1?(x(),F(M,{key:0},[l(o,{label:"种果树比例"},{default:n(()=>[l(m,{modelValue:t.furitTree,"onUpdate:modelValue":e[13]||(e[13]=a=>t.furitTree=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),l(o,{label:"钓鱼比例"},{default:n(()=>[l(m,{modelValue:t.fishing,"onUpdate:modelValue":e[14]||(e[14]=a=>t.fishing=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),l(o,{label:"种菜比例"},{default:n(()=>[l(m,{modelValue:t.vegetable,"onUpdate:modelValue":e[15]||(e[15]=a=>t.vegetable=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),l(o,{label:"狩猎比例"},{default:n(()=>[l(m,{modelValue:t.hunting,"onUpdate:modelValue":e[16]||(e[16]=a=>t.hunting=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),l(o,{label:"生态位比例"},{default:n(()=>[l(m,{modelValue:t.ecology,"onUpdate:modelValue":e[17]||(e[17]=a=>t.ecology=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1}),l(o,{label:"捡馅饼比例"},{default:n(()=>[l(m,{modelValue:t.pie,"onUpdate:modelValue":e[18]||(e[18]=a=>t.pie=a),disabled:!0,precision:2,step:1e-4},null,8,["modelValue"])]),_:1})],64)):N("",!0),t.deductedFrom===2?(x(),oe(o,{key:1,label:"扣除目标",prop:"directDeductionTarget"},{default:n(()=>[l(Y,{modelValue:V.value,"onUpdate:modelValue":e[19]||(e[19]=a=>V.value=a),onChange:A},{default:n(()=>[l(b,{label:"fruit"},{default:n(()=>e[23]||(e[23]=[f("种果树")])),_:1,__:[23]}),l(b,{label:"fishing"},{default:n(()=>e[24]||(e[24]=[f("钓鱼")])),_:1,__:[24]}),l(b,{label:"vegetable"},{default:n(()=>e[25]||(e[25]=[f("种菜")])),_:1,__:[25]}),l(b,{label:"hunting"},{default:n(()=>e[26]||(e[26]=[f("狩猎")])),_:1,__:[26]}),l(b,{label:"ecology"},{default:n(()=>e[27]||(e[27]=[f("生态位")])),_:1,__:[27]}),l(b,{label:"pie"},{default:n(()=>e[28]||(e[28]=[f("捡馅饼")])),_:1,__:[28]})]),_:1},8,["modelValue"])]),_:1})):N("",!0),l(o,{label:"描述",prop:"desc"},{default:n(()=>[l(G,{modelValue:t.desc,"onUpdate:modelValue":e[20]||(e[20]=a=>t.desc=a),type:"textarea",rows:3,placeholder:"请输入描述",onChange:e[21]||(e[21]=a=>r("desc"))},null,8,["modelValue"])]),_:1}),l(o,null,{default:n(()=>[l(u,{type:"primary",onClick:U,loading:R.value},{default:n(()=>[f(B(y.value?"更新":"创建"),1)]),_:1},8,["loading"]),l(u,{onClick:h},{default:n(()=>e[29]||(e[29]=[f("取消")])),_:1,__:[29]})]),_:1})]),_:1},8,["model"])]),_:1})])}}});const ce=ue(ge,[["__scopeId","data-v-c0773fcc"]]);export{ce as default};
